@page "/EditCharacter/{ID}"

@inject FirebaseData Data
@inject FirebaseAuth Auth
@inject NavigationManager Navigation
@using System.Text.Json 

<div class="PbtASystemContainer BackPanel">
	
	<div>
		<EditForm Model="Character" OnSubmit="Submit">
			<div class="d-flex w-100">
				<div class="d-flex flex-column flex-grow-1">
					<div class="DataBoxSmall">
						<div class="DataHeader">Nombre:</div>
						<div class="DataBody">
							<InputText style="width: 100%; padding: 5px; background: var(--bs-gray-700);color: white;border: none;" @bind-Value=Character.Name />
						</div>
					</div>
					<div class="DataBoxSmall">
						<div class="DataHeader">Tipo:</div>
						<div class="DataBody">
							<InputText style="width: 100%; padding: 5px;background: var(--bs-gray-700);color: white;border: none;" @bind-Value=Character.Kind />
						</div>
					</div>
					<div class="DataBoxSmall">
						<div class="DataHeader">Tick:</div>
						<div class="DataBody">
							<InputText style="width: 100%; padding: 5px;background: var(--bs-gray-700);color: white;border: none;" @bind-Value=Character.Tick />
						</div>
					</div>
				</div>
				<div class="FAB">
					<i class="bi bi-x-square PanelButton red" @onclick=Dismiss />
					<i class="bi bi-check-square PanelButton green" @onclick=Submit />
				</div>
			</div>

			
			<div class="DataBox mt-3">
				<div class="DataHeader">Aspecto:</div>
				<div class="DataBody">
					<InputTextArea style="width: 100%;background: var(--bs-gray-700);color: white;border: none;" @bind-Value=Character.Aspecto />
				</div>
			</div>
			<div class="DataBox">
				<div class="DataHeader">Detalles:</div>
				<div class="DataBody">
					<InputTextArea style="width: 100%;background: var(--bs-gray-700);color: white;border: none;" @bind-Value=Character.Details />
				</div>
			</div>
			<div class="DataBox">
				<div class="DataHeader">Objetivo actual:</div>
				<div class="DataBody">
					<InputTextArea style="width: 100%;background: var(--bs-gray-700);color: white;border: none;" @bind-Value=Character.CurrentGoal />
				</div>
			</div>
			<div class="DataBox">
				<div class="DataHeader">Objetivo final:</div>
				<div class="DataBody">
					<InputTextArea style="width: 100%;background: var(--bs-gray-700);color: white;border: none;" @bind-Value=Character.FinalGoal />
				</div>
			</div>
			@if (Auth.IsMaster)
			{
				<div class="DataBox">
					<div class="DataHeader">Master seeds:</div>
					<div class="DataBody">
						<InputTextArea style="width: 100%;background: var(--bs-gray-700);color: white;border: none;" @bind-Value=Character.MasterSeeds />
					</div>
				</div>
			}
			else
			{
				<div class="DataBox">
					<div class="DataHeader opacity-25">Las notas para el master han sido ocultadas</div>
				</div>
			}
			<div class="DataBox">
				<div class="DataHeader">Ticks:</div>
				<div class="DataBody">
					<div class="d-flex gap-2"><InputCheckbox @bind-Value=Character.IsDead></InputCheckbox>Muerto</div>
					<div class="d-flex gap-2"><InputCheckbox @bind-Value=Character.IsNPC></InputCheckbox>NPC</div>
				</div>
			</div>


			<div class="d-flex align-items-center justify-content-center flex-column">
				<InputFile OnChange="LoadFile" class="form-control" style="background: var(--bs-gray-700); border: none; color: white;" />

				<img src="@Data64" class="mt-2"/>
			</div>
			
			<div class="d-flex gap-2 justify-content-center align-items-center mt-2">
				<button class="btn btn-danger ">MUERTO</button>
			</div>
		</EditForm>
	</div>
</div>

@code {
	[Parameter] public string ID { get; set; }
	private Character Character = new();
	private Character Backup = new();
	private string Data64 = "";
	private string OriginalImage = "";
	[Inject] IJSRuntime JS { get; set; }

	protected async override Task OnParametersSetAsync()
	{
		await Connectors.SetConnectors(JS, Data, Auth);

		var _id = new Guid(ID);
		Character = Data.GetCharacterByID(_id);

		Backup = Character.Duplicate();

		if (Data64 == "")
			RetrieveImage();

	}

	protected override void OnAfterRender(bool firstRender)
	{
		if(Data64 == "")
			RetrieveImage();
	}

	private async void LoadFile(InputFileChangeEventArgs e)
	{
		var format = "image/png";
		var resizedImage = await e.File.RequestImageFileAsync(format, 500, 500);
		var buffer = new byte[resizedImage.Size];
		await resizedImage.OpenReadStream().ReadAsync(buffer);
		Data64 = $"data: {format};base64,{Convert.ToBase64String(buffer)}";

		await Data.StoreImageBase64(Data64, Data.CurrentCharacter.ID);
		StateHasChanged();
	}

	private async void RetrieveImage()
	{
		if(Data.IsConnectorSet)
			Data64 = await Data.getImageBase64Async();

		OriginalImage = Data64;
		StateHasChanged();
	}

	private async Task Submit()
	{
		await Data.StoreCharacter(Character);
		Navigation.NavigateTo($"/Character/{Data.CurrentCharacter.ID}");
	}

	private async Task Dismiss()
	{
		Character = Backup;
		await Data.StoreImageBase64(OriginalImage, Data.CurrentCharacter.ID);
		Navigation.NavigateTo($"/Character/{Data.CurrentCharacter.ID}");
	}
}
